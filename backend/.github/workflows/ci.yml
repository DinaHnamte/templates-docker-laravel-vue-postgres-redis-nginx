name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      APP_ENV: testing
      APP_DEBUG: true
      APP_URL: http://localhost
      DB_CONNECTION: sqlite
      DB_DATABASE: /home/runner/work/delivery-app/delivery-app/backend/database/database.sqlite
      QUEUE_CONNECTION: sync
      CACHE_DRIVER: file
      SESSION_DRIVER: file
      SANCTUM_STATEFUL_DOMAINS: localhost
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: sqlite, pdo_sqlite
          coverage: none

      - name: Install composer dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Prepare environment
        run: |
          [ -f .env ] || { [ -f .env.example ] && cp .env.example .env || touch .env; }
          php -r "file_put_contents('.env', preg_replace('/^APP_KEY=.*/m', 'APP_KEY=base64:'.base64_encode(random_bytes(32)), file_get_contents('.env')));"
          mkdir -p database
          touch database/database.sqlite

      - name: Generate app key
        run: php artisan key:generate --force

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: php artisan test --no-ansi

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check -- --noEmit

      - name: Build
        run: npm run build

